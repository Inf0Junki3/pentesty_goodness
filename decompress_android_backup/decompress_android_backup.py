# decompress_android_backup.py: takes your backup.ab and turns it in to a tar.
# Inf0Junki3, February 2016.
import                  argparse                                                                    
from functools import   partial                                                                     
import                  shutil                                                                      
import                  zlib                                                                        

parser = argparse.ArgumentParser("Decompresses an unencrypted android backup file into tar format") 
parser.add_argument("backup_file", help="The file to decompress")                                   
parser.add_argument("dest_tar", help="The destination tar file path")                               

args = parser.parse_args()                                                                          
if args.dest_tar is None:                                                                           
    dest = shutil.mktemp()                                                                          
else:                                                                                               
    dest = args.dest_tar                                                                            

print "Stripping off the first 24 bytes of the backup file"                                         
dest_file = open(dest, "wb")                                                                        
orig = open(args.backup_file, "rb")                                                                 
orig.seek(24)                                                                                       
print "Decompressing the file 1024 bytes at a time"                                                 
decompressor = zlib.decompressobj(zlib.MAX_WBITS)                                                   
for cur_chunk in iter(partial(orig.read, 1024), ""):                                                
    decompressed_chunk = decompressor.decompress(cur_chunk)                                         
    dest_file.write(decompressed_chunk)                                                             
dest_file.flush()                                                                                   
dest_file.close()                                                                                   

print "Done! Resulting tar is here: {}".format(dest)